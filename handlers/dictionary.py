from aiogram import Router, types, F
from aiogram.filters import Command
from aiogram.types import ReplyKeyboardMarkup, KeyboardButton, ReplyKeyboardRemove

router = Router()
router.name = 'dictionary'

# Expanded dictionary of legal terms
LEGAL_TERMS = {
    "Абандон": "Добровільна відмова страхувальника від своїх прав на застраховане майно на користь страховщика з метою отримання повної страхової суми",
    "Авторське право": "Сукупність прав, які належать автору у зв'язку зі створенням і використанням твору літератури, науки чи мистецтва",
    "Аванс": "Грошова сума або інша майнова цінність, що видається наперед у рахунок майбутніх платежів",
    "Агент": "Особа, яка діє від імені та в інтересах іншої особи",
    "Адміністративне право": "Галузь права, що регулює суспільні відносини у сфері державного управління",
    "Аккредитив": "Форма безготівкових розрахунків, при якій банк-емітент за дорученням клієнта зобов'язується здійснити платіж",
    "Алібі": "Доказ невинуватості особи, що підтверджує її відсутність на місці злочину в момент його вчинення",
    "Анулювання": "Відміна, визнання недійсним правового акту чи документу",
    "Арбітражний суд": "Спеціалізований суд для вирішення економічних спорів",
    "Аукціон": "Публічний продаж майна, де власником стає особа, яка запропонувала найвищу ціну",
    "Адвокат": "Особа, яка здійснює захист прав та представництво законних інтересів фізичних і юридичних осіб",
    "Акт": "Офіційний документ, що має юридичне значення",
    "Амністія": "Повне або часткове звільнення від відбування покарання певної категорії осіб",
    "Апеляція": "Оскарження судового рішення до суду вищої інстанції",
    "Арбітраж": "Спосіб вирішення спорів, при якому сторони звертаються до арбітрів",
    "Арешт": "Утримання особи в умовах ізоляції від суспільства",
    "Банкрутство": "Визнана судом неспроможність боржника відновити свою платоспроможність",
    "Безвісна відсутність": "Встановлений судом факт тривалої відсутності особи в місці її постійного проживання",
    "Бенефіціар": "Особа, на користь якої здійснюються платежі або інші дії",
    "Біпатрид": "Особа, яка має громадянство двох або більше держав",
    "Варант": "Свідоцтво, що видається товарним складом про прийняття товару на зберігання",
    "Вето": "Право глави держави відхилити прийнятий парламентом закон",
    "Вандалізм": "Умисне знищення або пошкодження матеріальних і культурних цінностей",
    "Версія": "Одне з можливих пояснень факту або події в юридичній практиці",
    "Винагорода": "Плата за виконану роботу або надані послуги",
    "Відвід": "Право заявити про неможливість участі певної особи в розгляді справи",
    "Відповідач": "Сторона в судовому процесі, до якої предʼявлено позов",
    "Віндикація": "Витребування майна з чужого незаконного володіння",
    "Власність": "Право володіти, користуватися і розпоряджатися майном",
    "Гарантія": "Один із способів забезпечення виконання зобов'язань",
    "Грабіж": "Відкрите викрадення чужого майна",
    "Громадянство": "Правовий зв'язок особи з державою",
    "Давність": "Встановлений законом строк для захисту порушеного права",
    "Дарування": "Безоплатна передача майна у власність іншій особі",
    "Делікт": "Цивільне правопорушення, що завдає шкоди",
    "Денонсація": "Відмова від міжнародного договору в порядку, передбаченому цим договором",
    "Дебітор": "Особа, яка має грошову або майнову заборгованість",
    "Декрет": "Нормативний акт, який має силу закону",
    "Деліктоздатність": "Здатність особи нести відповідальність за свої протиправні дії",
    "Демпінг": "Продаж товарів за штучно заниженими цінами",
    "Депозит": "Вклад у банку або цінності, передані на зберігання",
    "Дієздатність": "Здатність особи своїми діями набувати прав і створювати обов'язки",
    "Довіреність": "Письмове уповноваження однієї особи іншій на вчинення юридичних дій",
    "Договір": "Угода двох або більше сторін про встановлення, зміну або припинення прав та обов'язків",
    "Доказ": "Фактичні дані, на підставі яких встановлюється наявність або відсутність обставин",
    "Евакуація": "Організоване вивезення населення та матеріальних цінностей з небезпечної території",
    "Евтаназія": "Умисне прискорення смерті невиліковно хворої людини з метою припинення страждань",
    "Екоцид": "Масове знищення рослинного або тваринного світу, отруєння атмосфери або водних ресурсів",
    "Експертиза": "Дослідження експертом питань, що потребують спеціальних знань",
    "Екстрадиція": "Видача особи іншій державі для кримінального переслідування",
    "Єдиноначальність": "Принцип управління, за якого керівник має право одноособово приймати рішення",
    "Жертва": "Особа, якій завдано моральної, фізичної або майнової шкоди",
    "Застава": "Спосіб забезпечення зобов'язань майном",
    "Затримання": "Тимчасовий запобіжний захід",
    "Заповіт": "Особисте розпорядження фізичної особи на випадок своєї смерті",
    "Захист": "Забезпечення охорони прав і свобод людини",
    "Злочин": "Суспільно небезпечне винне діяння",
    "Зловживання правом": "Здійснення права всупереч його призначенню з метою заподіяння шкоди",
    "Змова": "Таємна угода для досягнення певної мети, часто протиправної",
    "Зняття судимості": "Припинення всіх правових наслідків, пов'язаних із судимістю",
    "Імпічмент": "Процедура притягнення до відповідальності вищих посадових осіб",
    "Імунітет": "Відсутність відповідальності за певні дії",
    "Інкасо": "Банківська операція із отримання платежів за дорученням клієнта",
    "Інавгурація": "Урочиста церемонія вступу на посаду глави держави",
    "Інсайдер": "Особа, яка має доступ до конфіденційної інформації",
    "Інтелектуальна власність": "Права на результати творчої діяльності людини",
    "Іпотека": "Застава нерухомого майна для забезпечення зобов'язань",
    "Касація": "Оскарження судових рішень, які набрали законної сили",
    "Клопотання": "Офіційне прохання або подання",
    "Кодекс": "Систематизований законодавчий акт",
    "Казус": "Випадкова дія, яка має ознаки правопорушення, але здійснена без вини",
    "Канон": "Твердо встановлене правило, норма",
    "Кворум": "Встановлена законом або статутом найменша кількість учасників зборів",
    "Конституція": "Основний закон держави",
    "Контрабанда": "Незаконне переміщення товарів через митний кордон",
    "Конфіскація": "Примусове безоплатне вилучення майна у власність держави",
    "Кредитор": "Особа, яка має право вимагати від боржника виконання зобов'язань",
    "Легалізація": "Надання юридичної сили документу",
    "Легітимація": "Визнання або підтвердження законності певних прав чи повноважень",
    "Ліквідація": "Припинення діяльності юридичної особи",
    "Лобізм": "Діяльність з метою впливу на прийняття рішень державними органами",
    "Ліцензія": "Дозвіл на здійснення певного виду діяльності",
    "Майно": "Окрема річ або сукупність речей",
    "Медіація": "Посередництво у вирішенні спорів",
    "Мито": "Обов'язковий платіж при переміщенні товарів через митний кордон",
    "Місцезнаходження": "Адреса юридичної особи",
    "Мораторій": "Відстрочка виконання зобов'язань",
    "Набувальна давність": "Придбання права власності внаслідок тривалого володіння майном",
    "Надзвичайний стан": "Особливий правовий режим діяльності органів влади",
    "Накладна": "Документ, що підтверджує перевезення вантажу",
    "Нотаріус": "Уповноважена державою особа, яка вчиняє нотаріальні дії",
    "Обіг": "Рух товарів, коштів в процесі відтворення",
    "Обставина": "Факт, що має значення для вирішення справи",
    "Омбудсмен": "Уповноважений з прав людини",
    "Обвинувачення": "Твердження про вчинення особою злочину",
    "Опіка": "Правова форма захисту прав та інтересів неповнолітніх осіб",
    "Пакт": "Міжнародний договір, що має важливе політичне значення",
    "Паритет": "Рівність прав і обов'язків",
    "Патент": "Документ, що засвідчує авторство на винахід",
    "Пеня": "Неустойка за несвоєчасне виконання грошових зобов'язань",
    "Підсудність": "Розмежування компетенції між судами щодо розгляду справ",
    "Позов": "Звернення до суду за захистом порушеного права",
    "Покарання": "Захід державного примусу за вчинення злочину",
    "Правоздатність": "Здатність мати права та обов'язки",
    "Преамбула": "Вступна частина нормативно-правового акту",
    "Президія": "Керівний орган деяких установ",
    "Презумпція": "Припущення, що вважається істинним до доведення протилежного",
    "Прокурор": "Посадова особа, яка здійснює нагляд за додержанням законів",
    "Протокол": "Документ, що фіксує хід і результати процесуальних дій",
    "Реабілітація": "Відновлення прав особи, яка була незаконно засуджена",
    "Реєстр": "Список, перелік, система обліку",
    "Реєстрація": "Офіційне визнання та підтвердження певних фактів",
    "Реквізиція": "Примусове вилучення майна у власника з виплатою компенсації",
    "Рента": "Регулярний дохід з капіталу, землі або майна",
    "Рецидив": "Повторне вчинення злочину",
    "Санація": "Система заходів для запобігання банкрутству",
    "Секвестр": "Заборона користуватися майном, накладена органом влади",
    "Сертифікат": "Документ, що підтверджує певний факт",
    "Санкція": "Частина правової норми, що визначає наслідки її порушення",
    "Свідок": "Особа, якій відомі обставини, що підлягають доказуванню",
    "Сервітут": "Право користування чужим майном",
    "Суддя": "Посадова особа, уповноважена здійснювати правосуддя",
    "Таємниця": "Відомості, що підлягають охороні від публічного поширення",
    "Тендер": "Конкурс для вибору найкращої пропозиції",
    "Тягар доказування": "Обов'язок сторони довести обставини, на які вона посилається",
    "Узуфрукт": "Право користування чужим майном з правом привласнення плодів",
    "Ультиматум": "Категорична вимога з погрозою застосування санкцій",
    "Умисел": "Форма вини, при якій особа усвідомлює наслідки свого діяння",
    "Фальсифікація": "Умисне викривлення або підробка чого-небудь",
    "Фідуціар": "Особа, якій довірено управління майном",
    "Форс-мажор": "Непереборна сила, надзвичайні обставини",
    "Франшиза": "Частина збитків, що не відшкодовується страховиком",
    "Халатність": "Невиконання або неналежне виконання обов'язків",
    "Хуліганство": "Грубе порушення громадського порядку",
    "Хабар": "Неправомірна вигода у вигляді грошей, майна, послуг",
    "Цесія": "Передача права вимоги іншій особі",
    "Цінний папір": "Документ, що засвідчує майнові права",
    "Шантаж": "Вимагання під погрозою розголошення відомостей",
    "Шкода": "Негативні наслідки порушення прав особи",
    "Штраф": "Грошове стягнення, що накладається за правопорушення",
    "Юридична особа": "Організація, що має відокремлене майно і відповідає за своїми зобов'язаннями",
    "Юрисконсульт": "Правовий радник в установі або на підприємстві",
    "Юрисдикція": "Повноваження здійснювати правосуддя або вирішувати правові питання",
    "Юстиція": "Система судових та правоохоронних органів"
}

def get_dict_keyboard():
    """Create dictionary keyboard"""
    return ReplyKeyboardMarkup(
        keyboard=[
            [KeyboardButton(text="📖 Список термінів")],
            [KeyboardButton(text="🔍 Пошук терміну")],
            [KeyboardButton(text="↩️ Повернутися до меню")]
        ],
        resize_keyboard=True
    )

def get_main_keyboard():
    """Create main menu keyboard"""
    return ReplyKeyboardMarkup(
        keyboard=[
            [KeyboardButton(text="Юридичний тренер")],
            [KeyboardButton(text="Словник")],
            [KeyboardButton(text="База даних")],
            [KeyboardButton(text="Підготовка до іспитів")],
        ],
        resize_keyboard=True
    )

@router.message(Command("dict", "dictionary", "словник"))
@router.message(lambda m: m.text and m.text.strip() == "Словник")  # More precise text matching
async def show_dictionary_menu(message: types.Message):
    """Handle dictionary commands and menu selection"""
    await message.answer(
        "🔖 Юридичний словник\n\n"
        "Оберіть дію:",
        reply_markup=get_dict_keyboard()
    )

@router.message(lambda m: m.text == "📖 Список термінів")
async def show_terms_list(message: types.Message):
    """Show list of all terms"""
    terms_list = "📚 Список юридичних термінів:\n"
    
    current_letter = None
    for term in sorted(LEGAL_TERMS.keys()):
        first_letter = term[0]
        if first_letter != current_letter:
            current_letter = first_letter
            terms_list += f"\n{current_letter}\n"
        terms_list += f"• {term}\n"

    if len(terms_list) > 4000:
        parts = [terms_list[i:i+4000] for i in range(0, len(terms_list), 4000)]
        for part in parts:
            await message.answer(part)
    else:
        await message.answer(terms_list)

@router.message(lambda m: m.text == "↩️ Повернутися до меню")
async def return_to_main(message: types.Message):
    """Return to main menu"""
    await message.answer("Оберіть розділ:", reply_markup=get_main_keyboard())

@router.message(lambda m: m.text == "🔍 Пошук терміну")
async def search_prompt(message: types.Message):
    """Show search instructions"""
    await message.answer(
        "Введіть слово або частину слова для пошуку:",
        reply_markup=get_dict_keyboard()
    )

@router.message(lambda m: not any(x in m.text for x in ["📖 Список термінів", "🔍 Пошук терміну", "↩️ Повернутися до меню", "Словник", "Юридичний тренер", "База даних", "Підготовка до іспитів"]) and not m.text.startswith('/'))
async def handle_term_search(message: types.Message):
    """Handle term search"""
    query = message.text.lower().strip()
    results = []

    for term, definition in LEGAL_TERMS.items():
        if query in term.lower():
            results.append(f"📎 {term}:\n{definition}\n")

    if results:
        response = "Знайдені терміни:\n\n" + "\n".join(results)
        
        if len(response) > 4000:
            parts = [response[i:i+4000] for i in range(0, len(response), 4000)]
            for part in parts:
                await message.answer(part)
        else:
            await message.answer(response)
    else:
        await message.answer(
            "❌ Термін не знайдено\n\n"
            "📝 Поради:\n"
            "• Перевірте правопис\n"
            "• Спробуйте ввести частину слова\n"
            "• Подивіться повний список термінів",
            reply_markup=get_dict_keyboard()
        )