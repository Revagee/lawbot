from aiogram import Router, types
from aiogram import F
from aiogram.types import ReplyKeyboardMarkup, KeyboardButton
from aiogram.fsm.context import FSMContext
from aiogram.fsm.state import StatesGroup, State
from aiogram.filters import Command
import logging
import random

logger = logging.getLogger(__name__)

router = Router()
router.name = 'trainer'

class TrainerStates(StatesGroup):
    waiting_for_subject = State()
    waiting_for_answer = State()

# Expanded pool of questions
questions_pool = [
    {
        "question": "Яке джерело права є основним в Україні?",
        "options": [
            "Конституція України",
            "Судовий прецедент",
            "Міжнародні угоди",
            "Звичаєве право"
        ],
        "correct": 0,
        "explanation": "Конституція України є основним джерелом права в Україні та має найвищу юридичну силу."
    },
    {
        "question": "Що таке юридична особа?",
        "options": [
            "Фізична особа з правами",
            "Організація, що має права і обов'язки",
            "Державний орган",
            "Приватний підприємець"
        ],
        "correct": 1,
        "explanation": "Юридична особа - це організація, яка має відокремлене майно, може від свого імені набувати майнових і особистих немайнових прав і нести обов'язки."
    },
    {
        "question": "Який орган здійснює конституційне судочинство в Україні?",
        "options": [
            "Верховний Суд",
            "Конституційний Суд України",
            "Вищий антикорупційний суд",
            "Верховна Рада України"
        ],
        "correct": 1,
        "explanation": "Конституційний Суд України є єдиним органом конституційної юрисдикції в Україні."
    },
    {
        "question": "Яка форма державного правління в Україні?",
        "options": [
            "Президентська республіка",
            "Парламентська республіка",
            "Змішана республіка",
            "Конституційна монархія"
        ],
        "correct": 2,
        "explanation": "Україна є змішаною (парламентсько-президентською) республікою."
    },
    {
        "question": "Який термін повноважень Президента України?",
        "options": [
            "4 роки",
            "5 років",
            "6 років",
            "7 років"
        ],
        "correct": 1,
        "explanation": "Згідно з Конституцією України, Президент України обирається строком на 5 років."
    },
    {
        "question": "Хто є джерелом влади в Україні згідно з Конституцією?",
        "options": [
            "Президент",
            "Верховна Рада",
            "Народ України",
            "Кабінет Міністрів"
        ],
        "correct": 2,
        "explanation": "Згідно зі статтею 5 Конституції України, носієм суверенітету і єдиним джерелом влади в Україні є народ."
    },
    {
        "question": "З якого віку настає кримінальна відповідальність в Україні?",
        "options": [
            "З 14 років",
            "З 16 років",
            "З 18 років",
            "З 21 року"
        ],
        "correct": 1,
        "explanation": "Загальний вік кримінальної відповідальності в Україні - 16 років, хоча за деякі тяжкі злочини відповідальність настає з 14 років."
    },
    {
        "question": "Який орган приймає закони в Україні?",
        "options": [
            "Президент України",
            "Верховна Рада України",
            "Кабінет Міністрів України",
            "Конституційний Суд України"
        ],
        "correct": 1,
        "explanation": "Єдиним органом законодавчої влади в Україні є парламент - Верховна Рада України."
    },
    {
        "question": "Що таке презумпція невинуватості?",
        "options": [
            "Право на захист",
            "Особа вважається невинуватою до доведення вини",
            "Право на справедливий суд",
            "Право на оскарження"
        ],
        "correct": 1,
        "explanation": "Презумпція невинуватості - це принцип, згідно з яким особа вважається невинуватою у вчиненні злочину, доки її вину не буде доведено в законному порядку."
    },
    {
        "question": "Який основний документ регулює сімейні відносини в Україні?",
        "options": [
            "Цивільний кодекс",
            "Сімейний кодекс",
            "Конституція України",
            "Кодекс про шлюб та сім'ю"
        ],
        "correct": 1,
        "explanation": "Сімейний кодекс України є основним нормативно-правовим актом, що регулює сімейні відносини."
    },
    {
        "question": "Що таке правоздатність?",
        "options": [
            "Здатність мати права",
            "Здатність здійснювати права",
            "Здатність відповідати за правопорушення",
            "Здатність бути свідком у суді"
        ],
        "correct": 0,
        "explanation": "Правоздатність - це здатність мати цивільні права та обов'язки. Виникає з моменту народження."
    },
    {
        "question": "Яка максимальна тривалість робочого тижня в Україні?",
        "options": [
            "36 годин",
            "38 годин",
            "40 годин",
            "42 години"
        ],
        "correct": 2,
        "explanation": "Згідно з Кодексом законів про працю України, нормальна тривалість робочого тижня не може перевищувати 40 годин."
    },
    {
        "question": "Що таке дієздатність?",
        "options": [
            "Здатність мати права",
            "Здатність своїми діями набувати прав і обов'язків",
            "Здатність бути свідком",
            "Здатність працювати"
        ],
        "correct": 1,
        "explanation": "Дієздатність - це здатність своїми діями набувати цивільних прав і створювати для себе цивільні обов'язки."
    },
    {
        "question": "Який мінімальний вік укладення шлюбу в Україні?",
        "options": [
            "16 років",
            "17 років",
            "18 років",
            "21 рік"
        ],
        "correct": 2,
        "explanation": "За загальним правилом, шлюбний вік в Україні встановлено у 18 років."
    },
    {
        "question": "Що таке апеляція?",
        "options": [
            "Звернення до суду",
            "Оскарження рішення суду",
            "Судове засідання",
            "Виконання рішення суду"
        ],
        "correct": 1,
        "explanation": "Апеляція - це оскарження судового рішення до суду вищої інстанції."
    },
    {
        "question": "Що таке трудовий договір?",
        "options": [
            "Угода про виконання роботи",
            "Угода між працівником і роботодавцем",
            "Документ про зарплату",
            "Наказ про прийняття на роботу"
        ],
        "correct": 1,
        "explanation": "Трудовий договір - це угода між працівником і роботодавцем, за якою працівник зобов'язується виконувати роботу, а роботодавець - забезпечувати умови праці."
    },
    {
        "question": "Який максимальний випробувальний термін для працівників?",
        "options": [
            "1 місяць",
            "3 місяці",
            "6 місяців",
            "1 рік"
        ],
        "correct": 1,
        "explanation": "За загальним правилом, максимальний строк випробування при прийнятті на роботу становить 3 місяці."
    },
    {
        "question": "Що таке позовна давність?",
        "options": [
            "Строк розгляду справи в суді",
            "Строк для захисту права за позовом",
            "Строк виконання рішення суду",
            "Строк подання апеляції"
        ],
        "correct": 1,
        "explanation": "Позовна давність - це строк, у межах якого особа може звернутися до суду з вимогою про захист свого цивільного права або інтересу."
    },
    {
        "question": "Який загальний строк позовної давності в Україні?",
        "options": [
            "1 рік",
            "2 роки",
            "3 роки",
            "5 років"
        ],
        "correct": 2,
        "explanation": "Загальний строк позовної давності в Україні становить 3 роки."
    },
    {
        "question": "Що таке заповіт?",
        "options": [
            "Договір дарування",
            "Особисте розпорядження на випадок смерті",
            "Документ про право власності",
            "Свідоцтво про спадщину"
        ],
        "correct": 1,
        "explanation": "Заповіт - це особисте розпорядження фізичної особи на випадок своєї смерті."
    },
    {
        "question": "З якого віку особа може скласти заповіт?",
        "options": [
            "З 14 років",
            "З 16 років",
            "З 18 років",
            "З 21 року"
        ],
        "correct": 2,
        "explanation": "Право на заповіт має фізична особа з повною цивільною дієздатністю, тобто з 18 років."
    },
    {
        "question": "Що таке необхідна оборона?",
        "options": [
            "Захист від нападу",
            "Самозахист від протиправних посягань",
            "Допомога поліції",
            "Затримання злочинця"
        ],
        "correct": 1,
        "explanation": "Необхідна оборона - це дії, вчинені з метою захисту від суспільно небезпечного посягання."
    },
    {
        "question": "Який строк дії авторського права в Україні?",
        "options": [
            "25 років",
            "50 років",
            "70 років після смерті автора",
            "100 років"
        ],
        "correct": 2,
        "explanation": "Майнові права автора діють протягом усього його життя і 70 років після його смерті."
    },
    {
        "question": "Що таке декларативний патент?",
        "options": [
            "Патент на винахід",
            "Патент без перевірки",
            "Тимчасовий патент",
            "Міжнародний патент"
        ],
        "correct": 1,
        "explanation": "Декларативний патент - це патент, який видається під відповідальність заявника без проведення експертизи на відповідність умовам патентоздатності."
    },
    {
        "question": "Який мінімальний статутний капітал для ТОВ?",
        "options": [
            "1000 грн",
            "Не встановлено",
            "10000 грн",
            "50000 грн"
        ],
        "correct": 1,
        "explanation": "В Україні мінімальний розмір статутного капіталу ТОВ законодавчо не встановлено."
    },
    {
        "question": "Що таке реституція?",
        "options": [
            "Відшкодування збитків",
            "Повернення сторін у початковий стан",
            "Сплата штрафу",
            "Визнання договору недійсним"
        ],
        "correct": 1,
        "explanation": "Реституція - це повернення сторін недійсного правочину в початковий майновий стан."
    },
    {
        "question": "Який строк позовної давності для трудових спорів про виплату зарплати?",
        "options": [
            "1 місяць",
            "3 місяці",
            "1 рік",
            "Без обмеження"
        ],
        "correct": 3,
        "explanation": "Для вимог про виплату заробітної плати строк позовної давності не встановлюється."
    },
    {
        "question": "Що таке застава?",
        "options": [
            "Спосіб забезпечення зобов'язань",
            "Вид договору купівлі-продажу",
            "Форма розрахунку",
            "Вид кредиту"
        ],
        "correct": 0,
        "explanation": "Застава - це спосіб забезпечення виконання зобов'язань, при якому кредитор має право в разі невиконання боржником зобов'язання одержати задоволення за рахунок заставленого майна."
    },
    {
        "question": "Який максимальний строк випробування для керівників?",
        "options": [
            "1 місяць",
            "3 місяці",
            "6 місяців",
            "1 рік"
        ],
        "correct": 2,
        "explanation": "Для керівників підприємств, їх заступників, головних бухгалтерів строк випробування може бути встановлено до 6 місяців."
    },
    {
        "question": "Що таке суброгація?",
        "options": [
            "Заміна кредитора у зобов'язанні",
            "Перехід прав страхувальника",
            "Відмова від прав",
            "Передача боргу"
        ],
        "correct": 1,
        "explanation": "Суброгація - це перехід до страховика прав страхувальника щодо відшкодування збитків."
    },
    {
        "question": "Яка тривалість щорічної відпустки?",
        "options": [
            "14 днів",
            "24 календарні дні",
            "30 календарних днів",
            "60 календарних днів"
        ],
        "correct": 1,
        "explanation": "Мінімальна тривалість щорічної основної відпустки становить 24 календарні дні."
    },
    {
        "question": "Що таке форс-мажор?",
        "options": [
            "Страховий випадок",
            "Непереборна сила",
            "Порушення договору",
            "Зміна обставин"
        ],
        "correct": 1,
        "explanation": "Форс-мажор (непереборна сила) - це надзвичайні та невідворотні обставини, що об'єктивно унеможливлюють виконання зобов'язань."
    },
    {
        "question": "Який строк для прийняття спадщини?",
        "options": [
            "3 місяці",
            "6 місяців",
            "9 місяців",
            "1 рік"
        ],
        "correct": 1,
        "explanation": "Для прийняття спадщини встановлюється строк у 6 місяців, який починається з часу відкриття спадщини."
    },
    {
        "question": "Що таке емансипація?",
        "options": [
            "Звільнення від відповідальності",
            "Надання повної цивільної дієздатності",
            "Визнання особи недієздатною",
            "Обмеження дієздатності"
        ],
        "correct": 1,
        "explanation": "Емансипація - це надання особі, яка досягла 16 років, повної цивільної дієздатності."
    },
    {
        "question": "Яка максимальна тривалість відрядження?",
        "options": [
            "30 днів",
            "60 днів",
            "1 рік",
            "Не обмежена"
        ],
        "correct": 3,
        "explanation": "Законодавство України не встановлює максимальної тривалості відрядження."
    },
    {
        "question": "Що таке завдаток?",
        "options": [
            "Грошова позика",
            "Спосіб забезпечення зобов'язань",
            "Передоплата",
            "Штраф"
        ],
        "correct": 1,
        "explanation": "Завдаток - це грошова сума або рухоме майно, що видається кредиторові боржником у рахунок належних з нього платежів, на підтвердження зобов'язання і на забезпечення його виконання."
    },
    {
        "question": "Який строк дії довіреності?",
        "options": [
            "1 рік",
            "3 роки",
            "5 років",
            "Визначається в довіреності"
        ],
        "correct": 3,
        "explanation": "Строк дії довіреності визначається у самій довіреності. Якщо строк не вказаний, вона зберігає чинність до припинення її дії чи скасування."
    },
    {
        "question": "Що таке прогул?",
        "options": [
            "Запізнення на роботу",
            "Відсутність на роботі більше 3 годин",
            "Неявка на роботу без поважних причин",
            "Передчасне залишення роботи"
        ],
        "correct": 2,
        "explanation": "Прогул - це відсутність працівника на роботі без поважних причин протягом усього робочого дня."
    }
]
criminal_questions = [
    {
        "question": "Що є підставою кримінальної відповідальності?",
        "options": [
            "Вчинення особою суспільно небезпечного діяння",
            "Наявність складу кримінального правопорушення",
            "Рішення суду",
            "Затримання особи"
        ],
        "correct": 1,
        "explanation": "Відповідно до ст. 2 ККУ, підставою кримінальної відповідальності є вчинення особою суспільно небезпечного діяння, яке містить склад кримінального правопорушення."
    },
    {
        "question": "Задача: Особа А проникла до квартири Особи Б з метою крадіжки. Під час крадіжки Особа Б повернулася додому, і Особа А, злякавшись, втекла, нічого не вкравши. Як кваліфікувати дії Особи А?",
        "options": [
            "Замах на крадіжку",
            "Закінчена крадіжка",
            "Готування до крадіжки",
            "Відсутній склад злочину"
        ],
        "correct": 0,
        "explanation": "Дії особи слід кваліфікувати як замах на крадіжку, оскільки вона почала виконання об'єктивної сторони злочину (проникнення до житла), але не довела його до кінця з причин, що не залежали від її волі."
    },
    {
        "question": "У якому випадку особа підлягає кримінальній відповідальності за готування до злочину?",
        "options": [
            "У всіх випадках",
            "Тільки за тяжкі злочини",
            "За тяжкі та особливо тяжкі злочини",
            "Тільки за особливо тяжкі злочини"
        ],
        "correct": 2,
        "explanation": "Відповідно до ст. 14 ККУ, готування до злочину невеликої тяжкості не тягне за собою кримінальної відповідальності. Відповідальність настає лише за готування до тяжкого чи особливо тяжкого злочину."
    },
    {
        "question": "Задача: Особа А, перебуваючи в стані сильного душевного хвилювання, спричинила тяжкі тілесні ушкодження Особі Б, яка перед цим вчинила протизаконне насильство щодо Особи А. Як кваліфікувати дії Особи А?",
        "options": [
            "Умисне тяжке тілесне ушкодження (ст. 121 ККУ)",
            "Умисне тяжке тілесне ушкодження у стані сильного душевного хвилювання (ст. 123 ККУ)",
            "Необхідна оборона (ст. 36 ККУ)",
            "Умисне легке тілесне ушкодження"
        ],
        "correct": 1,
        "explanation": "Дії особи кваліфікуються за ст. 123 ККУ як умисне тяжке тілесне ушкодження, заподіяне у стані сильного душевного хвилювання, оскільки стан викликаний протизаконним насильством з боку потерпілого."
    },
    {
        "question": "Що таке необхідна оборона?",
        "options": [
            "Заподіяння шкоди нападнику",
            "Дії, вчинені з метою захисту від суспільно небезпечного посягання",
            "Затримання злочинця",
            "Самосуд над правопорушником"
        ],
        "correct": 1,
        "explanation": "Необхідна оборона - це дії, вчинені з метою захисту охоронюваних законом прав та інтересів особи, яка захищається, або іншої особи від суспільно небезпечного посягання."
    },
    {
        "question": "Що є підставою кримінальної відповідальності?",
        "options": [
            "Вчинення особою суспільно небезпечного діяння",
            "Наявність складу кримінального правопорушення",
            "Рішення суду",
            "Затримання особи"
        ],
        "correct": 1,
        "explanation": "Відповідно до ст. 2 ККУ, підставою кримінальної відповідальності є вчинення особою суспільно небезпечного діяння, яке містить склад кримінального правопорушення."
    },
    {
        "question": "Що таке співучасть у злочині?",
        "options": [
            "Випадкова допомога злочинцю",
            "Умисна спільна участь декількох суб'єктів у вчиненні умисного кримінального правопорушення",
            "Переховування злочинця після злочину",
            "Недонесення про злочин"
        ],
        "correct": 1,
        "explanation": "Співучасть - це умисна спільна участь декількох суб'єктів кримінального правопорушення у вчиненні умисного кримінального правопорушення."
    },
    {
        "question": "Які види співучасників передбачені КК України?",
        "options": [
            "Виконавець, організатор, підбурювач, пособник",
            "Тільки виконавець і організатор",
            "Виконавець, замовник, спостерігач",
            "Організатор і виконавець"
        ],
        "correct": 0,
        "explanation": "Згідно зі ст. 27 ККУ, співучасниками кримінального правопорушення є виконавець, організатор, підбурювач та пособник."
    },
    {
        "question": "Що таке рецидив злочину?",
        "options": [
            "Вчинення нового злочину особою, яка має судимість",
            "Вчинення двох злочинів одночасно",
            "Вчинення злочину групою осіб",
            "Повторне вчинення будь-якого правопорушення"
        ],
        "correct": 0,
        "explanation": "Рецидивом злочинів визнається вчинення нового умисного кримінального правопорушення особою, яка має судимість за умисне кримінальне правопорушення."
    },
    {
        "question": "Що таке замах на злочин?",
        "options": [
            "Готування до злочину",
            "Умисна дія, безпосередньо спрямована на вчинення злочину, який не було доведено до кінця",
            "Думки про вчинення злочину",
            "Погроза вчинити злочин"
        ],
        "correct": 1,
        "explanation": "Замахом на кримінальне правопорушення є вчинення особою з прямим умислом діяння, безпосередньо спрямованого на вчинення кримінального правопорушення, якщо при цьому воно не було доведено до кінця з причин, що не залежали від її волі."
    },
    {
        "question": "Які види покарань передбачені для неповнолітніх?",
        "options": [
            "Тільки штраф",
            "Штраф, громадські роботи, виправні роботи, арешт, позбавлення волі",
            "Тільки позбавлення волі",
            "Тільки громадські роботи"
        ],
        "correct": 1,
        "explanation": "До неповнолітніх можуть бути застосовані такі види покарань: штраф, громадські роботи, виправні роботи, арешт, позбавлення волі на певний строк."
    },
    {
        "question": "Що таке крайня необхідність?",
        "options": [
            "Заподіяння шкоди правоохоронюваним інтересам для усунення небезпеки",
            "Необхідна оборона",
            "Виконання наказу",
            "Затримання злочинця"
        ],
        "correct": 0,
        "explanation": "Крайня необхідність - це заподіяння шкоди правоохоронюваним інтересам для усунення небезпеки, що безпосередньо загрожує особі чи охоронюваним законом правам цієї людини або інших осіб."
    }
]

def get_trainer_keyboard():
    """Create keyboard for trainer menu"""
    return ReplyKeyboardMarkup(
        keyboard=[
            [KeyboardButton(text="Загальні питання")],
            [KeyboardButton(text="Кримінальне право")],
            [KeyboardButton(text="/menu")]  # Back to main menu
        ],
        resize_keyboard=True
    )

@router.message(F.text == "Юридичний тренер")
@router.message(Command("trainer"))
async def handle_trainer_button(message: types.Message, state: FSMContext):
    await message.answer(
        "Оберіть тему для тренування:",
        reply_markup=get_trainer_keyboard()
    )
    await state.set_state(TrainerStates.waiting_for_subject)

async def start_subject_training(message: types.Message, state: FSMContext, questions, subject_name):
    """
    Start training for selected subject
    """
    if len(questions) < 10:
        await message.answer(
            "На жаль, недостатньо питань для тренування. Повідомте адміністратора.",
            reply_markup=get_main_keyboard()
        )
        await state.clear()
        return

    selected_questions = random.sample(questions, 10)
    await state.update_data(
        current_question=0,
        correct_answers=0,
        user_answers=[],
        selected_questions=selected_questions,
        subject=subject_name
    )
    
    question = selected_questions[0]
    await message.answer(
        f"📚 Тема: {subject_name}\n\n❓ {question['question']}",
        reply_markup=generate_keyboard(question["options"])
    )
    await state.set_state(TrainerStates.waiting_for_answer)

def generate_keyboard(options):
    """
    Create keyboard with answer options
    """
    buttons = [[KeyboardButton(text=option)] for option in options]
    buttons.append([KeyboardButton(text="/menu")])  # Add menu button
    return ReplyKeyboardMarkup(keyboard=buttons, resize_keyboard=True)

def get_main_keyboard():
    """Return to main menu keyboard"""
    return ReplyKeyboardMarkup(
        keyboard=[
            [KeyboardButton(text="/trainer")],
            [KeyboardButton(text="/menu")]
        ],
        resize_keyboard=True
    )

    

@router.message(TrainerStates.waiting_for_subject)
async def handle_subject_selection(message: types.Message, state: FSMContext):
    if message.text == "Загальні питання":
        await start_subject_training(message, state, questions_pool, "Загальні питання")
    elif message.text == "Кримінальне право":
        await start_subject_training(message, state, criminal_questions, "Кримінальне право")
    elif message.text == "/menu":
        await message.answer("Повернення до головного меню", reply_markup=get_main_keyboard())
        await state.clear()
    else:
        await message.answer(
            "Будь ласка, оберіть тему з клавіатури",
            reply_markup=get_trainer_keyboard()
        )

@router.message(TrainerStates.waiting_for_answer)
async def check_answer(message: types.Message, state: FSMContext):
    """
    Check user's answer
    """
    # Handle menu command
    if message.text == "/menu":
        await message.answer("Повернення до головного меню", reply_markup=get_main_keyboard())
        await state.clear()
        return

    data = await state.get_data()
    current_question = data.get("current_question", 0)
    correct_answers = data.get("correct_answers", 0)
    user_answers = data.get("user_answers", [])
    selected_questions = data.get("selected_questions", [])
    subject = data.get("subject", "")
    question = selected_questions[current_question]

    # Save user's answer
    user_answers.append({
        "question": question["question"],
        "user_answer": message.text,
        "correct_answer": question["options"][question["correct"]],
        "is_correct": message.text == question["options"][question["correct"]]
    })

    # Check answer
    is_correct = message.text == question["options"][question["correct"]]
    if is_correct:
        correct_answers += 1
        await message.answer("✅ Правильно!\n\n" + question["explanation"])
    else:
        await message.answer(
            f"❌ Неправильно!\nПравильна відповідь: {question['options'][question['correct']]}\n\n" + 
            question["explanation"]
        )

    # Move to next question
    current_question += 1
    await state.update_data(
        current_question=current_question, 
        correct_answers=correct_answers,
        user_answers=user_answers
    )

    if current_question < 10:
        next_question = selected_questions[current_question]
        await message.answer(
            f"📚 Тема: {subject}\n\n❓ {next_question['question']}",
            reply_markup=generate_keyboard(next_question["options"])
        )
    else:
        # Generate summary
        percentage = (correct_answers / 10) * 100
        summary = [
            f"🎉 Вітаємо! Ви завершили тренування з теми \"{subject}\"!\n",
            f"📊 Ваш результат: {correct_answers} правильних відповідей з 10",
            f"Відсоток правильних відповідей: {percentage:.1f}%\n",
            "📝 Огляд відповідей:\n"
        ]
        
        for i, answer in enumerate(user_answers, 1):
            summary.append(f"\n{i}. {answer['question']}")
            summary.append(f"❔ Ваша відповідь: {answer['user_answer']}")
            if answer['is_correct']:
                summary.append("✅ Правильно!")
            else:
                summary.append(f"❌ Неправильно. Правильна відповідь: {answer['correct_answer']}")

        summary.append("\nНатисніть /trainer щоб пройти нове тренування або /menu, щоб повернутися до головного меню.")

        await message.answer(
            "\n".join(summary),
            reply_markup=get_main_keyboard()
        )
        await state.clear()