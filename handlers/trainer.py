from aiogram import Router, types
from aiogram import F
from aiogram.types import ReplyKeyboardMarkup, KeyboardButton
from aiogram.fsm.context import FSMContext
from aiogram.fsm.state import StatesGroup, State
from aiogram.filters import Command
from .menu import get_main_keyboard
import logging
import random

logger = logging.getLogger(__name__)

router = Router()
router.name = 'trainer'

class TrainerStates(StatesGroup):
    waiting_for_subject = State()
    waiting_for_answer = State()

# Expanded pool of questions
questions_pool = [
    {
        "question": "Яке джерело права є основним в Україні?",
        "options": [
            "Конституція України",
            "Судовий прецедент",
            "Міжнародні угоди",
            "Звичаєве право"
        ],
        "correct": 0,
        "explanation": "Конституція України є основним джерелом права в Україні та має найвищу юридичну силу."
    },
    {
        "question": "Що таке юридична особа?",
        "options": [
            "Фізична особа з правами",
            "Організація, що має права і обов'язки",
            "Державний орган",
            "Приватний підприємець"
        ],
        "correct": 1,
        "explanation": "Юридична особа - це організація, яка має відокремлене майно, може від свого імені набувати майнових і особистих немайнових прав і нести обов'язки."
    },
    {
        "question": "Який орган здійснює конституційне судочинство в Україні?",
        "options": [
            "Верховний Суд",
            "Конституційний Суд України",
            "Вищий антикорупційний суд",
            "Верховна Рада України"
        ],
        "correct": 1,
        "explanation": "Конституційний Суд України є єдиним органом конституційної юрисдикції в Україні."
    },
    {
        "question": "Яка форма державного правління в Україні?",
        "options": [
            "Президентська республіка",
            "Парламентська республіка",
            "Змішана республіка",
            "Конституційна монархія"
        ],
        "correct": 2,
        "explanation": "Україна є змішаною (парламентсько-президентською) республікою."
    },
    {
        "question": "Який термін повноважень Президента України?",
        "options": [
            "4 роки",
            "5 років",
            "6 років",
            "7 років"
        ],
        "correct": 1,
        "explanation": "Згідно з Конституцією України, Президент України обирається строком на 5 років."
    },
    {
        "question": "Хто є джерелом влади в Україні згідно з Конституцією?",
        "options": [
            "Президент",
            "Верховна Рада",
            "Народ України",
            "Кабінет Міністрів"
        ],
        "correct": 2,
        "explanation": "Згідно зі статтею 5 Конституції України, носієм суверенітету і єдиним джерелом влади в Україні є народ."
    },
    {
        "question": "З якого віку настає кримінальна відповідальність в Україні?",
        "options": [
            "З 14 років",
            "З 16 років",
            "З 18 років",
            "З 21 року"
        ],
        "correct": 1,
        "explanation": "Загальний вік кримінальної відповідальності в Україні - 16 років, хоча за деякі тяжкі злочини відповідальність настає з 14 років."
    },
    {
        "question": "Який орган приймає закони в Україні?",
        "options": [
            "Президент України",
            "Верховна Рада України",
            "Кабінет Міністрів України",
            "Конституційний Суд України"
        ],
        "correct": 1,
        "explanation": "Єдиним органом законодавчої влади в Україні є парламент - Верховна Рада України."
    },
    {
        "question": "Що таке презумпція невинуватості?",
        "options": [
            "Право на захист",
            "Особа вважається невинуватою до доведення вини",
            "Право на справедливий суд",
            "Право на оскарження"
        ],
        "correct": 1,
        "explanation": "Презумпція невинуватості - це принцип, згідно з яким особа вважається невинуватою у вчиненні злочину, доки її вину не буде доведено в законному порядку."
    },
    {
        "question": "Який основний документ регулює сімейні відносини в Україні?",
        "options": [
            "Цивільний кодекс",
            "Сімейний кодекс",
            "Конституція України",
            "Кодекс про шлюб та сім'ю"
        ],
        "correct": 1,
        "explanation": "Сімейний кодекс України є основним нормативно-правовим актом, що регулює сімейні відносини."
    },
    {
        "question": "Що таке правоздатність?",
        "options": [
            "Здатність мати права",
            "Здатність здійснювати права",
            "Здатність відповідати за правопорушення",
            "Здатність бути свідком у суді"
        ],
        "correct": 0,
        "explanation": "Правоздатність - це здатність мати цивільні права та обов'язки. Виникає з моменту народження."
    },
    {
        "question": "Яка максимальна тривалість робочого тижня в Україні?",
        "options": [
            "36 годин",
            "38 годин",
            "40 годин",
            "42 години"
        ],
        "correct": 2,
        "explanation": "Згідно з Кодексом законів про працю України, нормальна тривалість робочого тижня не може перевищувати 40 годин."
    },
    {
        "question": "Що таке дієздатність?",
        "options": [
            "Здатність мати права",
            "Здатність своїми діями набувати прав і обов'язків",
            "Здатність бути свідком",
            "Здатність працювати"
        ],
        "correct": 1,
        "explanation": "Дієздатність - це здатність своїми діями набувати цивільних прав і створювати для себе цивільні обов'язки."
    },
    {
        "question": "Який мінімальний вік укладення шлюбу в Україні?",
        "options": [
            "16 років",
            "17 років",
            "18 років",
            "21 рік"
        ],
        "correct": 2,
        "explanation": "За загальним правилом, шлюбний вік в Україні встановлено у 18 років."
    },
    {
        "question": "Що таке апеляція?",
        "options": [
            "Звернення до суду",
            "Оскарження рішення суду",
            "Судове засідання",
            "Виконання рішення суду"
        ],
        "correct": 1,
        "explanation": "Апеляція - це оскарження судового рішення до суду вищої інстанції."
    },
    {
        "question": "Що таке трудовий договір?",
        "options": [
            "Угода про виконання роботи",
            "Угода між працівником і роботодавцем",
            "Документ про зарплату",
            "Наказ про прийняття на роботу"
        ],
        "correct": 1,
        "explanation": "Трудовий договір - це угода між працівником і роботодавцем, за якою працівник зобов'язується виконувати роботу, а роботодавець - забезпечувати умови праці."
    },
    {
        "question": "Який максимальний випробувальний термін для працівників?",
        "options": [
            "1 місяць",
            "3 місяці",
            "6 місяців",
            "1 рік"
        ],
        "correct": 1,
        "explanation": "За загальним правилом, максимальний строк випробування при прийнятті на роботу становить 3 місяці."
    },
    {
        "question": "Що таке позовна давність?",
        "options": [
            "Строк розгляду справи в суді",
            "Строк для захисту права за позовом",
            "Строк виконання рішення суду",
            "Строк подання апеляції"
        ],
        "correct": 1,
        "explanation": "Позовна давність - це строк, у межах якого особа може звернутися до суду з вимогою про захист свого цивільного права або інтересу."
    },
    {
        "question": "Який загальний строк позовної давності в Україні?",
        "options": [
            "1 рік",
            "2 роки",
            "3 роки",
            "5 років"
        ],
        "correct": 2,
        "explanation": "Загальний строк позовної давності в Україні становить 3 роки."
    },
    {
        "question": "Що таке заповіт?",
        "options": [
            "Договір дарування",
            "Особисте розпорядження на випадок смерті",
            "Документ про право власності",
            "Свідоцтво про спадщину"
        ],
        "correct": 1,
        "explanation": "Заповіт - це особисте розпорядження фізичної особи на випадок своєї смерті."
    },
    {
        "question": "З якого віку особа може скласти заповіт?",
        "options": [
            "З 14 років",
            "З 16 років",
            "З 18 років",
            "З 21 року"
        ],
        "correct": 2,
        "explanation": "Право на заповіт має фізична особа з повною цивільною дієздатністю, тобто з 18 років."
    },
    {
        "question": "Що таке необхідна оборона?",
        "options": [
            "Захист від нападу",
            "Самозахист від протиправних посягань",
            "Допомога поліції",
            "Затримання злочинця"
        ],
        "correct": 1,
        "explanation": "Необхідна оборона - це дії, вчинені з метою захисту від суспільно небезпечного посягання."
    },
    {
        "question": "Який строк дії авторського права в Україні?",
        "options": [
            "25 років",
            "50 років",
            "70 років після смерті автора",
            "100 років"
        ],
        "correct": 2,
        "explanation": "Майнові права автора діють протягом усього його життя і 70 років після його смерті."
    },
    {
        "question": "Що таке декларативний патент?",
        "options": [
            "Патент на винахід",
            "Патент без перевірки",
            "Тимчасовий патент",
            "Міжнародний патент"
        ],
        "correct": 1,
        "explanation": "Декларативний патент - це патент, який видається під відповідальність заявника без проведення експертизи на відповідність умовам патентоздатності."
    },
    {
        "question": "Який мінімальний статутний капітал для ТОВ?",
        "options": [
            "1000 грн",
            "Не встановлено",
            "10000 грн",
            "50000 грн"
        ],
        "correct": 1,
        "explanation": "В Україні мінімальний розмір статутного капіталу ТОВ законодавчо не встановлено."
    },
    {
        "question": "Що таке реституція?",
        "options": [
            "Відшкодування збитків",
            "Повернення сторін у початковий стан",
            "Сплата штрафу",
            "Визнання договору недійсним"
        ],
        "correct": 1,
        "explanation": "Реституція - це повернення сторін недійсного правочину в початковий майновий стан."
    },
    {
        "question": "Який строк позовної давності для трудових спорів про виплату зарплати?",
        "options": [
            "1 місяць",
            "3 місяці",
            "1 рік",
            "Без обмеження"
        ],
        "correct": 3,
        "explanation": "Для вимог про виплату заробітної плати строк позовної давності не встановлюється."
    },
    {
        "question": "Що таке застава?",
        "options": [
            "Спосіб забезпечення зобов'язань",
            "Вид договору купівлі-продажу",
            "Форма розрахунку",
            "Вид кредиту"
        ],
        "correct": 0,
        "explanation": "Застава - це спосіб забезпечення виконання зобов'язань, при якому кредитор має право в разі невиконання боржником зобов'язання одержати задоволення за рахунок заставленого майна."
    },
    {
        "question": "Який максимальний строк випробування для керівників?",
        "options": [
            "1 місяць",
            "3 місяці",
            "6 місяців",
            "1 рік"
        ],
        "correct": 2,
        "explanation": "Для керівників підприємств, їх заступників, головних бухгалтерів строк випробування може бути встановлено до 6 місяців."
    },
    {
        "question": "Що таке суброгація?",
        "options": [
            "Заміна кредитора у зобов'язанні",
            "Перехід прав страхувальника",
            "Відмова від прав",
            "Передача боргу"
        ],
        "correct": 1,
        "explanation": "Суброгація - це перехід до страховика прав страхувальника щодо відшкодування збитків."
    },
    {
        "question": "Яка тривалість щорічної відпустки?",
        "options": [
            "14 днів",
            "24 календарні дні",
            "30 календарних днів",
            "60 календарних днів"
        ],
        "correct": 1,
        "explanation": "Мінімальна тривалість щорічної основної відпустки становить 24 календарні дні."
    },
    {
        "question": "Що таке форс-мажор?",
        "options": [
            "Страховий випадок",
            "Непереборна сила",
            "Порушення договору",
            "Зміна обставин"
        ],
        "correct": 1,
        "explanation": "Форс-мажор (непереборна сила) - це надзвичайні та невідворотні обставини, що об'єктивно унеможливлюють виконання зобов'язань."
    },
    {
        "question": "Який строк для прийняття спадщини?",
        "options": [
            "3 місяці",
            "6 місяців",
            "9 місяців",
            "1 рік"
        ],
        "correct": 1,
        "explanation": "Для прийняття спадщини встановлюється строк у 6 місяців, який починається з часу відкриття спадщини."
    },
    {
        "question": "Що таке емансипація?",
        "options": [
            "Звільнення від відповідальності",
            "Надання повної цивільної дієздатності",
            "Визнання особи недієздатною",
            "Обмеження дієздатності"
        ],
        "correct": 1,
        "explanation": "Емансипація - це надання особі, яка досягла 16 років, повної цивільної дієздатності."
    },
    {
        "question": "Яка максимальна тривалість відрядження?",
        "options": [
            "30 днів",
            "60 днів",
            "1 рік",
            "Не обмежена"
        ],
        "correct": 3,
        "explanation": "Законодавство України не встановлює максимальної тривалості відрядження."
    },
    {
        "question": "Що таке завдаток?",
        "options": [
            "Грошова позика",
            "Спосіб забезпечення зобов'язань",
            "Передоплата",
            "Штраф"
        ],
        "correct": 1,
        "explanation": "Завдаток - це грошова сума або рухоме майно, що видається кредиторові боржником у рахунок належних з нього платежів, на підтвердження зобов'язання і на забезпечення його виконання."
    },
    {
        "question": "Який строк дії довіреності?",
        "options": [
            "1 рік",
            "3 роки",
            "5 років",
            "Визначається в довіреності"
        ],
        "correct": 3,
        "explanation": "Строк дії довіреності визначається у самій довіреності. Якщо строк не вказаний, вона зберігає чинність до припинення її дії чи скасування."
    },
    {
        "question": "Що таке прогул?",
        "options": [
            "Запізнення на роботу",
            "Відсутність на роботі більше 3 годин",
            "Неявка на роботу без поважних причин",
            "Передчасне залишення роботи"
        ],
        "correct": 2,
        "explanation": "Прогул - це відсутність працівника на роботі без поважних причин протягом усього робочого дня."
    }
]
criminal_questions = [
    {
        "question": "Що є підставою кримінальної відповідальності?",
        "options": [
            "Вчинення особою суспільно небезпечного діяння",
            "Наявність складу кримінального правопорушення",
            "Рішення суду",
            "Затримання особи"
        ],
        "correct": 1,
        "explanation": "Відповідно до ст. 2 ККУ, підставою кримінальної відповідальності є вчинення особою суспільно небезпечного діяння, яке містить склад кримінального правопорушення."
    },
    {
        "question": "Задача: Особа А проникла до квартири Особи Б з метою крадіжки. Під час крадіжки Особа Б повернулася додому, і Особа А, злякавшись, втекла, нічого не вкравши. Як кваліфікувати дії Особи А?",
        "options": [
            "Замах на крадіжку",
            "Закінчена крадіжка",
            "Готування до крадіжки",
            "Відсутній склад злочину"
        ],
        "correct": 0,
        "explanation": "Дії особи слід кваліфікувати як замах на крадіжку, оскільки вона почала виконання об'єктивної сторони злочину (проникнення до житла), але не довела його до кінця з причин, що не залежали від її волі."
    },
    {
        "question": "У якому випадку особа підлягає кримінальній відповідальності за готування до злочину?",
        "options": [
            "У всіх випадках",
            "Тільки за тяжкі злочини",
            "За тяжкі та особливо тяжкі злочини",
            "Тільки за особливо тяжкі злочини"
        ],
        "correct": 2,
        "explanation": "Відповідно до ст. 14 ККУ, готування до злочину невеликої тяжкості не тягне за собою кримінальної відповідальності. Відповідальність настає лише за готування до тяжкого чи особливо тяжкого злочину."
    },
    {
        "question": "Задача: Особа А, перебуваючи в стані сильного душевного хвилювання, спричинила тяжкі тілесні ушкодження Особі Б, яка перед цим вчинила протизаконне насильство щодо Особи А. Як кваліфікувати дії Особи А?",
        "options": [
            "Умисне тяжке тілесне ушкодження (ст. 121 ККУ)",
            "Умисне тяжке тілесне ушкодження у стані сильного душевного хвилювання (ст. 123 ККУ)",
            "Необхідна оборона (ст. 36 ККУ)",
            "Умисне легке тілесне ушкодження"
        ],
        "correct": 1,
        "explanation": "Дії особи кваліфікуються за ст. 123 ККУ як умисне тяжке тілесне ушкодження, заподіяне у стані сильного душевного хвилювання, оскільки стан викликаний протизаконним насильством з боку потерпілого."
    },
    {
        "question": "Що таке необхідна оборона?",
        "options": [
            "Заподіяння шкоди нападнику",
            "Дії, вчинені з метою захисту від суспільно небезпечного посягання",
            "Затримання злочинця",
            "Самосуд над правопорушником"
        ],
        "correct": 1,
        "explanation": "Необхідна оборона - це дії, вчинені з метою захисту охоронюваних законом прав та інтересів особи, яка захищається, або іншої особи від суспільно небезпечного посягання."
    },
    {
        "question": "Що є підставою кримінальної відповідальності?",
        "options": [
            "Вчинення особою суспільно небезпечного діяння",
            "Наявність складу кримінального правопорушення",
            "Рішення суду",
            "Затримання особи"
        ],
        "correct": 1,
        "explanation": "Відповідно до ст. 2 ККУ, підставою кримінальної відповідальності є вчинення особою суспільно небезпечного діяння, яке містить склад кримінального правопорушення."
    },
    {
        "question": "Що таке співучасть у злочині?",
        "options": [
            "Випадкова допомога злочинцю",
            "Умисна спільна участь декількох суб'єктів у вчиненні умисного кримінального правопорушення",
            "Переховування злочинця після злочину",
            "Недонесення про злочин"
        ],
        "correct": 1,
        "explanation": "Співучасть - це умисна спільна участь декількох суб'єктів кримінального правопорушення у вчиненні умисного кримінального правопорушення."
    },
    {
        "question": "Які види співучасників передбачені КК України?",
        "options": [
            "Виконавець, організатор, підбурювач, пособник",
            "Тільки виконавець і організатор",
            "Виконавець, замовник, спостерігач",
            "Організатор і виконавець"
        ],
        "correct": 0,
        "explanation": "Згідно зі ст. 27 ККУ, співучасниками кримінального правопорушення є виконавець, організатор, підбурювач та пособник."
    },
    {
        "question": "Що таке рецидив злочину?",
        "options": [
            "Вчинення нового злочину особою, яка має судимість",
            "Вчинення двох злочинів одночасно",
            "Вчинення злочину групою осіб",
            "Повторне вчинення будь-якого правопорушення"
        ],
        "correct": 0,
        "explanation": "Рецидивом злочинів визнається вчинення нового умисного кримінального правопорушення особою, яка має судимість за умисне кримінальне правопорушення."
    },
    {
        "question": "Що таке замах на злочин?",
        "options": [
            "Готування до злочину",
            "Умисна дія, безпосередньо спрямована на вчинення злочину, який не було доведено до кінця",
            "Думки про вчинення злочину",
            "Погроза вчинити злочин"
        ],
        "correct": 1,
        "explanation": "Замахом на кримінальне правопорушення є вчинення особою з прямим умислом діяння, безпосередньо спрямованого на вчинення кримінального правопорушення, якщо при цьому воно не було доведено до кінця з причин, що не залежали від її волі."
    },
    {
        "question": "Які види покарань передбачені для неповнолітніх?",
        "options": [
            "Тільки штраф",
            "Штраф, громадські роботи, виправні роботи, арешт, позбавлення волі",
            "Тільки позбавлення волі",
            "Тільки громадські роботи"
        ],
        "correct": 1,
        "explanation": "До неповнолітніх можуть бути застосовані такі види покарань: штраф, громадські роботи, виправні роботи, арешт, позбавлення волі на певний строк."
    },
    {
        "question": "Що таке крайня необхідність?",
        "options": [
            "Заподіяння шкоди правоохоронюваним інтересам для усунення небезпеки",
            "Необхідна оборона",
            "Виконання наказу",
            "Затримання злочинця"
        ],
        "correct": 0,
        "explanation": "Крайня необхідність - це заподіяння шкоди правоохоронюваним інтересам для усунення небезпеки, що безпосередньо загрожує особі чи охоронюваним законом правам цієї людини або інших осіб."
    },
    {
        "question": "Задача: Особа А планувала вбити Особу Б і придбала для цього зброю, але була затримана до вчинення злочину. Як кваліфікувати дії Особи А?",
        "options": [
            "Замах на вбивство",
            "Готування до вбивства",
            "Незакінчений злочин",
            "Придбання зброї"
        ],
        "correct": 1,
        "explanation": "Дії особи кваліфікуються як готування до вбивства, оскільки особа здійснювала підготовчі дії (придбання зброї), але ще не почала виконання об'єктивної сторони злочину."
    },
    {
        "question": "За яких умов виникає право на необхідну оборону?",
        "options": [
            "Тільки при нападі озброєної особи",
            "При наявності будь-якої небезпеки",
            "При наявності реального суспільно небезпечного посягання",
            "Тільки при захисті власності"
        ],
        "correct": 2,
        "explanation": "Право на необхідну оборону виникає при наявності реального суспільно небезпечного посягання незалежно від можливості уникнути його або звернутися за допомогою до інших осіб чи органів влади."
    },
    {
        "question": "Задача: Особа А з помсти підпалила будинок Особи Б, внаслідок чого загинули люди. Особа А не бажала їх смерті. Яка форма вини щодо загибелі людей?",
        "options": [
            "Прямий умисел",
            "Непрямий умисел",
            "Злочинна недбалість",
            "Злочинна самовпевненість"
        ],
        "correct": 3,
        "explanation": "Щодо загибелі людей має місце злочинна самовпевненість, оскільки особа передбачала можливість настання смерті, але легковажно розраховувала на її відвернення."
    },
    {
        "question": "Що таке ексцес виконавця?",
        "options": [
            "Відмова від вчинення злочину",
            "Вчинення злочину, який не охоплювався умислом інших співучасників",
            "Добровільна відмова від злочину",
            "Перевищення меж необхідної оборони"
        ],
        "correct": 1,
        "explanation": "Ексцес виконавця - це вчинення виконавцем злочину, який не охоплювався умислом інших співучасників. За ексцес відповідає лише виконавець."
    },
    {
        "question": "Задача: Особа А, погрожуючи ножем, вимагала у Особи Б віддати гроші. Особа Б, захищаючись, завдала тяжких тілесних ушкоджень Особі А. Як кваліфікувати дії Особи Б?",
        "options": [
            "Умисне тяжке тілесне ушкодження",
            "Необхідна оборона",
            "Перевищення меж необхідної оборони",
            "Умисне легке тілесне ушкодження"
        ],
        "correct": 1,
        "explanation": "Дії особи Б є необхідною обороною, оскільки вона захищалась від реального суспільно небезпечного посягання, а застосоване насильство відповідало небезпечності посягання."
    },
    {
        "question": "Задача: Група осіб домовилась про крадіжку. Під час крадіжки один із учасників застосував насильство до потерпілого. Як кваліфікувати дії інших учасників?",
        "options": [
            "Розбій у співучасті",
            "Крадіжка у співучасті",
            "Грабіж у співучасті",
            "Кожен відповідає за фактично вчинене"
        ],
        "correct": 3,
        "explanation": "Застосування насильства є ексцесом виконавця. Інші співучасники відповідають за крадіжку, оскільки насильство не охоплювалось їх умислом."
    },
    {
        "question": "Що таке добровільна відмова від злочину?",
        "options": [
            "Відмова від доведення злочину до кінця під впливом зовнішніх факторів",
            "Остаточне припинення особою підготовки до злочину або замаху на злочин за своєю волею",
            "Відмова від повторного вчинення злочину",
            "Відмова від участі у злочині на вимогу інших осіб"
        ],
        "correct": 1,
        "explanation": "Добровільна відмова - це остаточне припинення особою за своєю волею готування до злочину або замаху на злочин, якщо при цьому вона усвідомлювала можливість доведення злочину до кінця."
    },
    {
        "question": "За якої умови співучасть у злочині неможлива?",
        "options": [
            "При вчиненні злочину двома особами",
            "При вчиненні необережного злочину",
            "При вчиненні тяжкого злочину",
            "При вчиненні злочину повторно"
        ],
        "correct": 1,
        "explanation": "Співучасть можлива лише в умисних злочинах. При вчиненні необережного злочину співучасть виключається."
    },
    {
        "question": "Задача: Особа А дала Особі Б отруту, сказавши що це ліки. Особа Б дала отруту Особі В, яка померла. Хто підлягає кримінальній відповідальності?",
        "options": [
            "Обидві особи за вбивство",
            "Тільки Особа А за вбивство",
            "Тільки Особа Б за вбивство",
            "Ніхто не відповідає"
        ],
        "correct": 1,
        "explanation": "Відповідальність несе лише Особа А, яка використала Особу Б як 'невинуватого посередника'. Особа Б діяла невинно, не усвідомлюючи справжній характер своїх дій."
    },
    {
        "question": "Що таке казус (випадок) у кримінальному праві?",
        "options": [
            "Вчинення злочину через необережність",
            "Вчинення злочину в стані афекту",
            "Заподіяння шкоди без вини",
            "Вчинення злочину групою осіб"
        ],
        "correct": 2,
        "explanation": "Казус (випадок) - це заподіяння шкоди за відсутності вини, коли особа не передбачала і не могла передбачити настання суспільно небезпечних наслідків свого діяння."
    },
    {
        "question": "Задача: Особа А придбала пістолет для самозахисту без відповідного дозволу. Як кваліфікувати такі дії?",
        "options": [
            "Не є злочином",
            "Незаконне придбання зброї",
            "Правомірний самозахист",
            "Адміністративне правопорушення"
        ],
        "correct": 1,
        "explanation": "Незаконне придбання вогнепальної зброї без передбаченого законом дозволу є кримінальним правопорушенням, передбаченим ст. 263 ККУ, незалежно від мети придбання."
    },
    {
        "question": "За яких умов особа звільняється від кримінальної відповідальності у зв'язку з дійовим каяттям?",
        "options": [
            "Лише при визнанні вини",
            "При щирому каятті, активному сприянні розкриттю злочину і повному відшкодуванні збитків",
            "При явці з повинною",
            "При примиренні з потерпілим"
        ],
        "correct": 1,
        "explanation": "Згідно зі ст. 45 ККУ, для звільнення від відповідальності у зв'язку з дійовим каяттям необхідна сукупність умов: щире каяття, активне сприяння розкриттю злочину та повне відшкодування збитків або усунення заподіяної шкоди."
    },
    {
        "question": "Задача: Особа А вчинила крадіжку, а через тиждень - грабіж. Яка кваліфікуюча ознака наявна в діях особи?",
        "options": [
            "Рецидив злочинів",
            "Повторність злочинів",
            "Сукупність злочинів",
            "Продовжуваний злочин"
        ],
        "correct": 1,
        "explanation": "У даному випадку має місце повторність злочинів, оскільки особа вчинила два окремих злочини проти власності. Рецидив відсутній, оскільки не було судимості за перший злочин."
    },
    {
        "question": "Що таке вік кримінальної відповідальності?",
        "options": [
            "Вік на момент вчинення злочину",
            "Вік на момент затримання",
            "Вік на момент винесення вироку",
            "Вік на момент досудового розслідування"
        ],
        "correct": 0,
        "explanation": "Вік кримінальної відповідальності визначається на момент вчинення злочину. Якщо особа досягла віку відповідальності на наступний день після вчинення злочину, вона не підлягає кримінальній відповідальності."
    },
    {
        "question": "Задача: Особа А, погрожуючи застосуванням зброї, заволоділа майном Особи Б. Фактично зброї у нападника не було. Як кваліфікувати дії?",
        "options": [
            "Грабіж",
            "Розбій без обтяжуючих обставин",
            "Розбій із застосуванням зброї",
            "Вимагання"
        ],
        "correct": 1,
        "explanation": "Дії кваліфікуються як розбій без обтяжуючих обставин, оскільки для кваліфікації має значення суб'єктивне сприйняття потерпілим погрози як реальної, а не фактична наявність зброї."
    },
    {
        "question": "Задача: Особа А з метою вбивства Особи Б стріляла в неї, але промахнулася. Як кваліфікувати дії?",
        "options": [
            "Замах на вбивство",
            "Готування до вбивства",
            "Хуліганство",
            "Незакінчений злочин"
        ],
        "correct": 0,
        "explanation": "Дії кваліфікуються як замах на вбивство, оскільки особа почала виконання об'єктивної сторони злочину (здійснила постріл), але не досягла бажаного результату з причин, що не залежали від її волі."
    },
    {
        "question": "Що таке конфіскація майна як вид покарання?",
        "options": [
            "Примусове безоплатне вилучення всього майна",
            "Примусове вилучення майна, набутого злочинним шляхом",
            "Примусове вилучення частини майна",
            "Примусове безоплатне вилучення майна у власність держави"
        ],
        "correct": 3,
        "explanation": "Конфіскація майна як вид покарання - це примусове безоплатне вилучення у власність держави всього або частини майна, яке є власністю засудженого, незалежно від його походження."
    },
    {
        "question": "За якої умови настає кримінальна відповідальність за погрозу вбивством?",
        "options": [
            "При будь-якій погрозі",
            "При наявності реальних підстав побоюватися здійснення погрози",
            "Лише при письмовій погрозі",
            "При погрозі з використанням зброї"
        ],
        "correct": 1,
        "explanation": "Кримінальна відповідальність за погрозу вбивством настає лише за наявності реальних підстав побоюватися здійснення цієї погрози, що визначається з урахуванням конкретних обставин справи."
    },
    {
        "question": "Задача: Особа А захищалась від нападу Особи Б і заподіяла їй смерть через необережність. Як кваліфікувати дії?",
        "options": [
            "Умисне вбивство",
            "Вбивство через необережність",
            "Необхідна оборона",
            "Перевищення меж необхідної оборони"
        ],
        "correct": 2,
        "explanation": "Якщо при необхідній обороні через необережність заподіяно смерть нападнику, дії того, хто оборонявся, не утворюють складу злочину - це правомірна необхідна оборона."
    },
    {
        "question": "Що таке кримінальний проступок?",
        "options": [
            "Будь-яке правопорушення",
            "Злочин невеликої тяжкості",
            "Діяння, за яке передбачене покарання до 2 років позбавлення волі або інше, більш м'яке покарання",
            "Адміністративне правопорушення"
        ],
        "correct": 2,
        "explanation": "Кримінальний проступок - це діяння, за яке передбачене основне покарання у виді штрафу в розмірі не більше трьох тисяч неоподатковуваних мінімумів доходів громадян або інше покарання, не пов'язане з позбавленням волі."
    }
]
civil_questions = [
    {
        "question": "Що є підставою виникнення цивільних прав та обов'язків?",
        "options": [
            "Тільки договори та угоди",
            "Тільки закони",
            "Договори та інші юридичні факти",
            "Тільки рішення суду"
        ],
        "correct": 2,
        "explanation": "Відповідно до ст. 11 ЦКУ, цивільні права та обов'язки виникають із дій осіб, передбачених актами цивільного законодавства, а також із дій осіб, що не передбачені цими актами, але за аналогією породжують цивільні права та обов'язки."
    },
    {
        "question": "Який строк позовної давності встановлено для вимог про визнання недійсним правочину, вчиненого під впливом насильства?",
        "options": [
            "1 рік",
            "3 роки",
            "5 років",
            "10 років"
        ],
        "correct": 2,
        "explanation": "Згідно зі ст. 258 ЦКУ, для вимог про визнання недійсним правочину, вчиненого під впливом насильства, встановлюється позовна давність у 5 років."
    },
    {
        "question": "З якого віку фізична особа може самостійно вчиняти дрібні побутові правочини?",
        "options": [
            "З 6 років",
            "З 10 років",
            "З 14 років",
            "З 16 років"
        ],
        "correct": 0,
        "explanation": "Відповідно до ст. 31 ЦКУ, фізична особа, яка не досягла 14 років (малолітня особа), має право самостійно вчиняти дрібні побутові правочини з 6 років."
    },
    {
        "question": "Що таке оферта?",
        "options": [
            "Пропозиція укласти договір",
            "Згода укласти договір",
            "Відмова від договору",
            "Зміна умов договору"
        ],
        "correct": 0,
        "explanation": "Оферта - це пропозиція укласти договір, яка містить істотні умови договору і виражає намір особи, яка її зробила, вважати себе зобов'язаною у разі її прийняття."
    },
    {
        "question": "Який максимальний строк договору оренди земельної ділянки?",
        "options": [
            "25 років",
            "50 років",
            "75 років",
            "Не більше 50 років"
        ],
        "correct": 1,
        "explanation": "Відповідно до ст. 793 ЦКУ, строк договору найму (оренди) земельної ділянки не може перевищувати 50 років."
    },
    {
        "question": "Що таке неустойка?",
        "options": [
            "Вид забезпечення виконання зобов'язання",
            "Форма розірвання договору",
            "Спосіб оплати",
            "Вид відшкодування збитків"
        ],
        "correct": 0,
        "explanation": "Неустойка (штраф, пеня) - це грошова сума або інше майно, які боржник повинен передати кредиторові у разі порушення боржником зобов'язання."
    },
    {
        "question": "Протягом якого строку спадкоємець може прийняти спадщину?",
        "options": [
            "3 місяці",
            "6 місяців",
            "9 місяців",
            "1 рік"
        ],
        "correct": 1,
        "explanation": "Відповідно до ст. 1270 ЦКУ, для прийняття спадщини встановлюється строк у шість місяців, який починається з часу відкриття спадщини."
    },
    {
        "question": "Хто не може бути опікуном або піклувальником?",
        "options": [
            "Особа, позбавлена батьківських прав",
            "Пенсіонери",
            "Іноземці",
            "Родичі"
        ],
        "correct": 0,
        "explanation": "Згідно зі ст. 64 ЦКУ, опікуном або піклувальником не може бути особа, позбавлена батьківських прав, якщо ці права не були поновлені."
    },
    {
        "question": "Яка форма заповіту є обов'язковою?",
        "options": [
            "Усна",
            "Проста письмова",
            "Письмова з нотаріальним посвідченням",
            "Будь-яка"
        ],
        "correct": 2,
        "explanation": "Відповідно до ст. 1247 ЦКУ, заповіт складається у письмовій формі, із зазначенням місця та часу його складення, та має бути посвідчений нотаріусом."
    },
    {
        "question": "Що таке сервітут?",
        "options": [
            "Право користування чужим майном",
            "Право власності",
            "Право на спадкування",
            "Право на оренду"
        ],
        "correct": 0,
        "explanation": "Сервітут - це право обмеженого користування чужим майном, наприклад, право проходу через чужу земельну ділянку."
    },
    {
        "question": "Який загальний строк позовної давності в цивільному праві?",
        "options": [
            "1 рік",
            "2 роки",
            "3 роки",
            "5 років"
        ],
        "correct": 2,
        "explanation": "Відповідно до ст. 257 ЦКУ, загальний строк позовної давності встановлюється тривалістю у три роки."
    },
    {
        "question": "З якого моменту юридична особа вважається створеною?",
        "options": [
            "З моменту прийняття рішення засновниками",
            "З моменту державної реєстрації",
            "З моменту початку діяльності",
            "З моменту відкриття рахунку в банку"
        ],
        "correct": 1,
        "explanation": "Юридична особа вважається створеною з дня її державної реєстрації в установленому законом порядку."
    },
    {
        "question": "Що таке акцепт?",
        "options": [
            "Пропозиція укласти договір",
            "Відповідь про прийняття пропозиції",
            "Відмова від пропозиції",
            "Зміна умов договору"
        ],
        "correct": 1,
        "explanation": "Акцепт - це відповідь особи, якій адресована пропозиція укласти договір, про її прийняття."
    },
    {
        "question": "Який мінімальний розмір статутного капіталу для акціонерного товариства?",
        "options": [
            "1000 мінімальних зарплат",
            "1250 мінімальних зарплат",
            "1500 мінімальних зарплат",
            "2500 мінімальних зарплат"
        ],
        "correct": 1,
        "explanation": "Мінімальний розмір статутного капіталу акціонерного товариства становить 1250 мінімальних заробітних плат."
    },
    {
        "question": "Що таке завдаток?",
        "options": [
            "Грошова сума, що видається однією стороною другій стороні",
            "Спосіб забезпечення виконання зобов'язання",
            "Форма оплати",
            "Вид неустойки"
        ],
        "correct": 1,
        "explanation": "Завдаток - це грошова сума або рухоме майно, що видається кредиторові боржником у рахунок належних з нього за договором платежів, на підтвердження зобов'язання і на забезпечення його виконання."
    }
]

def get_trainer_keyboard():
    """Create keyboard for trainer menu"""
    return ReplyKeyboardMarkup(
        keyboard=[
            [KeyboardButton(text="Загальні питання")],
            [KeyboardButton(text="Кримінальне право")],
            [KeyboardButton(text="Цивільне право")],
            [KeyboardButton(text="↩️ Повернутися до меню")]  # Changed to match menu.py
        ],
        resize_keyboard=True
    )

@router.message(F.text == "Юридичний тренер")
@router.message(Command("trainer"))
async def handle_trainer_button(message: types.Message, state: FSMContext):
    await message.answer(
        "Оберіть тему для тренування:",
        reply_markup=get_trainer_keyboard()
    )
    await state.set_state(TrainerStates.waiting_for_subject)

async def start_subject_training(message: types.Message, state: FSMContext, questions, subject_name):
    """
    Start training for selected subject
    """
    if len(questions) < 10:
        await message.answer(
            "На жаль, недостатньо питань для тренування. Повідомте адміністратора.",
            reply_markup=get_main_keyboard()
        )
        await state.clear()
        return

    selected_questions = random.sample(questions, 10)
    await state.update_data(
        current_question=0,
        correct_answers=0,
        user_answers=[],
        selected_questions=selected_questions,
        subject=subject_name
    )
    
    question = selected_questions[0]
    await message.answer(
        f"📚 Тема: {subject_name}\n\n❓ {question['question']}",
        reply_markup=generate_keyboard(question["options"])
    )
    await state.set_state(TrainerStates.waiting_for_answer)

def generate_keyboard(options):
    """
    Create keyboard with answer options
    """
    buttons = [[KeyboardButton(text=option)] for option in options]
    buttons.append([KeyboardButton(text="↩️ Повернутися до меню")])  # Changed to match menu.py
    return ReplyKeyboardMarkup(keyboard=buttons, resize_keyboard=True)

@router.message(TrainerStates.waiting_for_subject)
async def handle_subject_selection(message: types.Message, state: FSMContext):
    if message.text == "Загальні питання":
        await start_subject_training(message, state, questions_pool, "Загальні питання")
    elif message.text == "Кримінальне право":
        await start_subject_training(message, state, criminal_questions, "Кримінальне право")
    elif message.text == "Цивільне право":  # Added handler for civil law
        await start_subject_training(message, state, civil_questions, "Цивільне право")
    elif message.text == "↩️ Повернутися до меню":  # Changed to match menu.py
        await state.clear()
        await message.answer("Оберіть розділ:", reply_markup=get_main_keyboard())
    else:
        await message.answer(
            "Будь ласка, оберіть тему з клавіатури",
            reply_markup=get_trainer_keyboard()
        )

@router.message(TrainerStates.waiting_for_answer)
async def check_answer(message: types.Message, state: FSMContext):
    """
    Check user's answer
    """
    # Handle menu command
    if message.text == "↩️ Повернутися до меню":  # Changed to match menu.py
        await state.clear()
        await message.answer("Оберіть розділ:", reply_markup=get_main_keyboard())
        return

    data = await state.get_data()
    current_question = data.get("current_question", 0)
    correct_answers = data.get("correct_answers", 0)
    user_answers = data.get("user_answers", [])
    selected_questions = data.get("selected_questions", [])
    subject = data.get("subject", "")
    question = selected_questions[current_question]

    # Save user's answer
    user_answers.append({
        "question": question["question"],
        "user_answer": message.text,
        "correct_answer": question["options"][question["correct"]],
        "is_correct": message.text == question["options"][question["correct"]]
    })

    # Check answer
    is_correct = message.text == question["options"][question["correct"]]
    if is_correct:
        correct_answers += 1
        await message.answer("✅ Правильно!\n\n" + question["explanation"])
    else:
        await message.answer(
            f"❌ Неправильно!\nПравильна відповідь: {question['options'][question['correct']]}\n\n" + 
            question["explanation"]
        )

    # Move to next question
    current_question += 1
    await state.update_data(
        current_question=current_question, 
        correct_answers=correct_answers,
        user_answers=user_answers
    )

    if current_question < 10:
        next_question = selected_questions[current_question]
        await message.answer(
            f"📚 Тема: {subject}\n\n❓ {next_question['question']}",
            reply_markup=generate_keyboard(next_question["options"])
        )
    else:
        # Generate summary
        percentage = (correct_answers / 10) * 100
        summary = [
            f"🎉 Вітаємо! Ви завершили тренування з теми \"{subject}\"!\n",
            f"📊 Ваш результат: {correct_answers} правильних відповідей з 10",
            f"Відсоток правильних відповідей: {percentage:.1f}%\n",
            "📝 Огляд відповідей:\n"
        ]
        
        for i, answer in enumerate(user_answers, 1):
            summary.append(f"\n{i}. {answer['question']}")
            summary.append(f"❔ Ваша відповідь: {answer['user_answer']}")
            if answer['is_correct']:
                summary.append("✅ Правильно!")
            else:
                summary.append(f"❌ Неправильно. Правильна відповідь: {answer['correct_answer']}")

        summary.append("\nНатисніть /trainer щоб пройти нове тренування або /menu, щоб повернутися до головного меню.")

        await message.answer(
            "\n".join(summary),
            reply_markup=get_main_keyboard()  # Changed to return to main menu after completion
        )
        await state.clear()